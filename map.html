<html>
<head>
  <meta charset="utf-8" />
  <title>Ski Touring Planning Map</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.10.3/math.min.js"></script>

  <link rel="stylesheet" href="./dist/MarkerCluster.css" />
  <link rel="stylesheet" href="./dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="./dist/leaflet-search.css" />

	<!-- For Geocoding -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
	<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

	<!-- For GPX displaying -->
  <script src="./dist/gpx.min.js"></script>

  <!-- For Routing -->
  <link rel="stylesheet" href="./dist/leaflet-routing-machine.css" />
  <script src="./dist/leaflet-routing-machine.js"></script>
  <script src="./dist/L.Routing.OpenRouteService.js"></script>
  <script src="./dist/polyline.js"></script>

	<!-- Right Click Menu -->
  <link rel="stylesheet" href="./dist/menu.css" />
  <script src="./dist/menu.js"></script>

  
  <script src="./dist/leaflet.markercluster-src.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>
  <script src="./dist/querystring.js"></script>
  <script src="./dist/leaflet-search.js"></script>

  <meta charset=utf-8>

  <style>
    #map { 
      width: 100%;
      height: 100%;
      position: absolute;
    }

    #wait {
      margin-left: 25%;
      margin-top: 15%;
      padding: 20px;
      width: 50%;
      height: 50%;
      min-height: 100px;
      background-color: #adaaa1ee;
      z-index: 100000;
      position: absolute;
    }
    #legend-slope {
      display: block;
      z-index: 100000;
      position: absolute;
      bottom: 5;
      right: 5;

      pointer-events: none;
      opacity: .85;
      height: 200px;
    }

    body{
      margin: 0px;
    }
  </style>
</head>

<body>
	<!-- Right Click Menu -->
	<div id="menu">
		<a href="#" onclick="startHere(); return false;">
			Start Here<span></span>
		</a>
		<a href="#" onclick="endHere(); return false;">
			End here<span></span>
		</a>
		<hr>
		<a href="#" onclick="copyLocation(); return false;">
			Copy Location <span></span>
		</a>
		<hr>
		<a href="#">
			Close
		</a>
			<!-- <img src="./images/pin-icon-start.png" />Copy Location <span>Ctrl + ?!</span> -->
	</div>


  <!-- Fork me on github -->
  <a href="https://github.com/Mael-Le-Garrec/ski_touring_map"><img style="position: absolute; top: 0; right: 0; border: 0; z-index:1000;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
  <div id="map"></div>

  <!-- Slope legend overlay -->
  <img src="https://download.openslopemap.org/LegendeOpenSlopeMap.png" id="legend-slope">

  <!-- Let's put an overlay on top of the map to tell the user to wait for the huts to load -->
  <div id="wait">
    <center style="margin-top: 20%;">
      <h2>Loading Points of Interest</h2>
      <img src="dist/img/loading.gif">

      <p>Points of Interest to be loaded:<br> tourism=hut, tourism=wilderness_hut</p>
    </center>
  </div>

  <script type="text/javascript">

		// helper function to get a time in hours / min / sec instead of millisecs
		function msToTime(duration) {
			var milliseconds = parseInt((duration % 1000) / 100),
				seconds = Math.floor((duration / 1000) % 60),
				minutes = Math.floor((duration / (1000 * 60)) % 60),
				hours = Math.floor((duration / (1000 * 60 * 60)) % 24);

			hours = (hours < 10) ? "0" + hours : hours;
			minutes = (minutes < 10) ? "0" + minutes : minutes;
			seconds = (seconds < 10) ? "0" + seconds : seconds;

			return hours + "h " + minutes + "m " + seconds + "." + milliseconds + "s";
		}

		// -------------------------------------------------------------
 	  // Add a function to get into the clipboard the current location
    function copyLocation(e)
    {
			var pos = cursorLat + " " + cursorLng;
			navigator.clipboard.writeText(pos).then(function() {}, function() {});
		}

		// -------------------------------------------------------------

    // Define our base tiles: we'll be using the OSM winter map
    var mapStr = 'https://w3.outdooractive.com/map/v1/png/osm_winter/{z}/{x}/{y}/t.png?project=api-dev-oa';
    var mapStr = 'https://a.tile.opentopomap.org/{z}/{x}/{y}.png'

    // It's useful to have the pistes to know where it's easy to ride
    // We'll take them from opensnowmap
    var pistesStr = 'http://tiles.opensnowmap.org/pistes/{z}/{x}/{y}.png';

    // Highly inclined slopes are dangerous, it's nice to have a map of those
    var slopesStr = 'https://tileserver1.openslopemap.org/OSloOVERLAY_LR_All_16/{z}/{x}/{y}.png';

    // Background tiles
    var base_tiles = L.tileLayer(mapStr,
        {
          type: 'map',
          maxZoom: 17,
          minZoom: 2,
          opacity: 0.7,
        });
    
    // Steepeness
    var slopes_tiles = L.tileLayer(slopesStr,
        {
          type: 'map',
          maxZoom: 16,
          minZoom: 2,
          opacity: 0.25,
        });
    
    // Pistes
    var pistes_tiles = L.tileLayer(pistesStr,
        {
          type: 'map',
          maxZoom: 19,
          minZoom: 11,
          opacity: 0.75,
        });

    // ------------------------------------------------------------
    // Finally, the map object with our base tiles and the different layers
    // Get the location in the URL if any 
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    var lng = urlParams.get('lng');
    var lat = urlParams.get('lat');
    var zoom = urlParams.get('z');

    if (lat && lng)
      var center = [lat, lng];
    
    var map = L.map('map', {
        center: (center) ? center : L.latLng(46, 5.2),
        zoom: (zoom) ? zoom : 6, 
        layers: [base_tiles, slopes_tiles, pistes_tiles]
    });
    // ------------------------------------------------------------
    
    // ------------------------------------------------------------
    // Whenever the map moves, update the URL
    map.on('moveend', function (){
        var mapCenter = map.getCenter();
        var mapZoom = map.getZoom();

        var newUrl = UpdateQueryString('z', mapZoom);
        history.pushState({}, null, newUrl);

        var newUrl = UpdateQueryString('lat', mapCenter.lat);
        history.pushState({}, null, newUrl);

        var newUrl = UpdateQueryString('lng', mapCenter.lng);
        history.pushState({}, null, newUrl);
      }
    );
    // ------------------------------------------------------------


    // ------------------------------------------------------------
    // Define the function that queries certain POIs and displays them
    function get_poi(poi, iconPOI, show)
    {
      $.getJSON(poi, function (osmDataAsJson) {
        var resultAsGeojson = osmtogeojson(osmDataAsJson);
        var resultLayer = L.geoJson(resultAsGeojson, {
          style: function (feature) {
            return {color: "#ff0000"};
          },
          pointToLayer: function (feature, latlng) {
            var name = feature.properties.tags.name;
            name = (name) ? name : null;

            return L.marker(latlng, {icon: iconPOI, title: feature.properties.tags.name});
          },
          filter: function (feature, layer) {
            var isPolygon = (feature.geometry) && (feature.geometry.type !== undefined) && (feature.geometry.type === "Polygon");
            if (isPolygon) {
              feature.geometry.type = "Point";
              var polygonCenter = L.latLngBounds(feature.geometry.coordinates[0]).getCenter();
              feature.geometry.coordinates = [ polygonCenter.lat, polygonCenter.lng ];
            }
            return true;
          },
          onEachFeature: function (feature, layer) {
            var popupContent = "";
            popupContent = popupContent + "<dt>@id</dt><dd>" + feature.properties.type + "/" + feature.properties.id + "</dd>";
            var keys = Object.keys(feature.properties.tags);
            keys.forEach(function (key) {
              poiKeys.add(key);
              popupContent = popupContent + "<dt>" + key + "</dt><dd>" + feature.properties.tags[key] + "</dd>";
            });
            popupContent = popupContent + "</dl>"
            layer.bindPopup(popupContent);
          }
        })
        // Add our markers to the map and the layer group
        resultLayer.addTo(poiLayers);

        // Disable the waiting div after the two loaded JSON
        var counter = document.getElementById("wait").getAttribute('counter');
        if (counter == 1)
          document.getElementById("wait").remove();
        else
          document.getElementById("wait").setAttribute("counter", 1);

      });
    }

    // Define icons for out huts
    var houseIcon = L.icon({
      iconUrl: 'images/house.png',
      iconSize: [25, 25],
      iconAnchor: [16, 25],
      popupAnchor: [0, -28]
    });
    var hutIcon = L.icon({
      iconUrl: 'images/hut.png',
      iconSize: [25, 25],
      iconAnchor: [16, 25],
      popupAnchor: [0, -28]
    });
    var peakIcon = L.icon({
      iconUrl: 'images/peak.png',
      iconSize: [25, 25],
      iconAnchor: [16, 25],
      popupAnchor: [0, -28]
    });
		// Define some for the GPX tracks
    var startIcon = L.icon({
      iconUrl: 'images/pin-icon-start.png',
      iconSize: [25, 25],
      iconAnchor: [16, 25],
      popupAnchor: [0, -28]
    });
    var endIcon = L.icon({
      iconUrl: 'images/pin-icon-end.png',
      iconSize: [25, 25],
      iconAnchor: [16, 25],
      popupAnchor: [0, -28]
    });


    // ------------------------------------------------------------
    // Define a layer group for the search function
    var poiLayers = L.layerGroup();
    var poiKeys = new Set();

    // Get the alpine huts and the wilderness huts
    get_poi("json/alpine_hut.json", houseIcon, true);
    get_poi("json/wilderness_hut.json", hutIcon, true);
    //get_poi("json/peak.json", peakIcon, false);
			
    // Add the search bar for addresses
		L.Control.geocoder({'placeholder': 'Search for locations'}).setPosition('topleft').addTo(map);

		// And add a search bar for the huts
    L.control.search({
      layer: poiLayers,
      initial: false,
			textPlaceholder: 'Search for huts',
      propertyName: 'title',
      buildTip: function(text, val) {
        return '<a href="#">' + text + '</a>';
      }
    }).addTo(map);
    
    // ------------------------------------------------------------
    // Look for GPX tracks and add them to the map
		var fileNames = new Array();
    $.ajax({
      url: "./dist/gpx/",
      success: function(data){
         $(data).find("td > a").each(function(){
           if ($(this).attr("href").endsWith(".gpx"))
           {
              var gpx = "./dist/gpx/" + $(this).attr("href"); // URL to your GPX file or the GPX itself
              new L.GPX(gpx, {
                async: true,
								marker_options: {
									startIconUrl: 'images/pin-icon-start.png',
									endIconUrl: 'images/pin-icon-end.png',
									shadowUrl: 'images/pin-shadow.png',
									wptIconUrls: {
										'': '',
									},
									popupAnchor: [0, -50],
								},
              }).on('loaded', function(e) {
								var gpx = e.target
								
								var keys = ["Distance", "Total Time", "Start", "End", "Elevation +", "Elevation -", "Max Altitude", "Min Altitude"];
								var funcs = [(gpx.get_distance() / 1000).toFixed(2) + " km", 
														 msToTime(gpx.get_total_time()), 
														 gpx.get_start_time().toUTCString(), 
														 gpx.get_end_time().toUTCString(), 
														 (gpx.get_elevation_gain()).toFixed(0) + " m",
														 (gpx.get_elevation_loss()).toFixed(0) + " m", 
														 (gpx.get_elevation_max()).toFixed(0) + " m", 
														 (gpx.get_elevation_min()).toFixed(0) + " m",
														];

								var popupContent = "";
								keys.forEach((key, index) => {
									popupContent = popupContent + "<dt>" + key + "</dt><dd>" + funcs[index] + "<dd>";
								});
								gpx.bindPopup(popupContent);
              }).addTo(map);
           }  
         });
      }
    }); 

    // ------------------------------------------------------------
    // Add a routing feature
		var geocoder =  L.Control.Geocoder.nominatim();
		var router = new L.Routing.osrmv1({profile: 'foot',});
    var router = new L.Routing.openrouteservice('5b3ce3597851110001cf624802f67373a031434889627fc550c9671f');

		var control = L.Routing.control({
			routeWhileDragging: true,
			geocoder: geocoder,
			router: router,
		}).addTo(map);


    // ------------------------------------------------------------
    // waypoints via URL
    function updateWaypointUrl()
    {
      var waypoints = control.getWaypoints();
      var waypointsUrl = []
      for (var i = 0; i < waypoints.length; i++)
      {
        if (waypoints[i].latLng)
        {
          var array = Array(waypoints[i].latLng.lat, waypoints[i].latLng.lng);
          console.log(array);
          waypointsUrl.push(array);
          var newUrl = UpdateQueryString('waypoints', JSON.stringify(waypointsUrl));
          history.pushState({}, null, newUrl);
        }
      }
    }

    control.getPlan().addEventListener("waypointsspliced", e => {
      updateWaypointUrl();
    });
    control.getPlan().addEventListener("waypointschanged", e => {
      updateWaypointUrl();
    });

    var waypoints = urlParams.get('waypoints');
    if (waypoints)
    {
      var points = JSON.parse(waypoints);
      for (var i = 0; i < points.length; i++)
        if (i < 2)
          control.spliceWaypoints(i, 1, new L.latLng(points[i]));
        else
          control.spliceWaypoints(i, 0, new L.latLng(points[i]));

    }
    // ------------------------------------------------------------
      
    // ------------------------------------------------------------
		// Store the position of the cursor
    var cursorLat;
    var cursorLng;
		var cursorLatLng;
		const Coordinates = L.Control.extend({
    onAdd: map => {
      const container = L.DomUtil.create("div");
      map.addEventListener("mousemove", e => {
          container.innerHTML = `
          <h2>Latitude 
            ${e.latlng.lat.toFixed(4)} <br> 
            Longitude ${e.latlng.lng.toFixed(4)}
            </h2>
          `;
					cursorLat = e.latlng.lat;
					cursorLng = e.latlng.lng;
					cursorLatLng = e.latlng;
			 });
			 return container;
			 }
		});
		map.addControl(new Coordinates({ position: "bottomleft" }));
    
		// ------------------------------------------------------------
		// Functions to put the current position to the geocoder and start routing

		function startHere()
		{
			var pos = cursorLat + " " + cursorLng;
			control.spliceWaypoints(0, 1, cursorLatLng);
		}
		
		function endHere()
		{
			var pos = cursorLat + " " + cursorLng;
			control.spliceWaypoints(control.getWaypoints().length - 1, 1, cursorLatLng);
		}

  </script>
</body>
</html>
